---
title: Unity Shader 入门（四）：透明效果知识储备
date: 2017/11/18
thumbnail: https://github.com/kurong00/blog/blob/master/thumbnail/shader4/shader4.png?raw=true
categories: Shader
---

## 导语
首先一个问题：如果场景中有非常多的物体，彼此之间有互相遮挡的情况，那么这些物体是按照什么样的渲染顺序进行渲染的呢？

### 深度缓冲
实际上，由于深度缓存（z-buffer）的存在,不透明的物体在不考虑渲染顺序的情况下也可以正确的被渲染。深度缓冲是用来解决物体可见性的问题，基本思想是：根据深度缓存里的值判断这个物体距离摄像机的距离。开始渲染一个片元的时候，需要把它的深度值和已存在于深度缓存中的值作比较，如果它的值距离摄像机更远那么就不会被渲染到屏幕上。否则更新片元的深度值到深度缓存中。

## 透明效果
我们可以不关心不透明物体的渲染顺序，因为在深度测试中就可以测试出物体离摄像机的距离再判断是否写入颜色缓冲。但是对于不透明物体，就没这么简单了。想要达到半透明的效果，我们要利用透明度混合。

### 透明度混合
透明度混合要关闭深度写入。这是因为：假如一个半透明物体在一个不透明物体的前面，如果开启深度写入的话，距离摄像机更远的不透明物体就会被剔除，但是依照常理我们是可以透过半透明的物体看到不透明的物体。但是这就破坏了深度缓冲的机制，这是非常不好但是不得不做的折中方法，也因此使得渲染顺序变得非常重要。（注意：关闭深度写入，但是没有关闭深度测试）

### 渲染顺序
我们考虑两种情况：
1. 既有半透明物体也有不透明物体：我们先渲染所有的不透明物体再渲染半透明物体
1. 全是半透明物体：开启深度测试，关闭深度写入的情况下将半透明物体按照距离摄像机的远近从后往前渲染。
    - 这里有一个小问题，深度缓冲中的值是像素级别的，而一个半透明物体很可能有非常多个像素，这么一来每一个像素的深度值都可能不一样，以此会产生<font color =  #D37885> 循环遮挡</font>的情况。
    - 为了规避上面的问题，常常会把大的模型分割成小的几块，这样即使出现渲染错误，也不会出现太出格的结果。

### Unity设置的渲染序列
类似之前`Tags { "RenderType"="Opaque" }`,我们可以用Queue标签来决定我们的模型是怎么渲染的。

队列名称|队列索引|索引描述
:--:|:--:|:--:|
Background|1000|最早被渲染的队列，一般绘制背景元素
Geometry|2000|默认渲染队列，不透明物体渲染队列
AlphaTest|2450|需要透明度测试的物体在这个队列渲染
Transparent|3000|使用透明度混合的物体在这个队列渲染
Overlay|4000|最后被渲染的物体在这个队列，一般用于叠加效果

### 代码设置

如果我们想要通过透明度混合来实现半透明效果，代码如下
```haxe
 SubShader
    {
        Tags { "RenderType"="Transparent" }  
        Pass { 
		    ZWrite Off ······
        } 
    }
```
ZWrite Off 意味者关闭深度写入，或者可以：
```haxe
 SubShader
    {
        Tags { "RenderType"="Transparent" }  
        ZWrite Off ······
        Pass { } 
    }
```
这样表示这个SubShader下的所有Pass都会关闭深度写入